{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-blue-900 px-6 py-4">
            <h2 class="text-white font-bold text-lg">New Patient Admission</h2>
            <p class="text-blue-200 text-sm">Enter clinical details to generate risk score.</p>
        </div>

        <div class="px-6 py-6 border-b border-slate-100 bg-slate-50">
            <label class="block text-xs font-bold text-slate-500 mb-3 uppercase tracking-wide">
                <i class="fa-solid fa-file-pdf mr-1"></i> Auto-Fill from Medical Report
            </label>

            <div class="relative group">
                <div id="dropZone"
                    class="relative border-2 border-dashed border-blue-200 rounded-xl p-6 text-center bg-white transition-all duration-300 hover:border-blue-400 hover:bg-blue-50 group-hover:shadow-sm">

                    <input type="file" id="pdfUpload" accept=".pdf"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                        onchange="handleFileSelect(this)">

                    <div class="space-y-2 pointer-events-none">
                        <div
                            class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fa-solid fa-cloud-arrow-up text-xl"></i>
                        </div>
                        <p class="text-sm font-medium text-slate-700">
                            <span class="text-blue-600 hover:underline">Click to upload</span> or drag and drop
                        </p>
                        <p class="text-xs text-slate-400">PDF files only (max 5MB)</p>
                        <p id="fileNameDisplay" class="text-sm font-bold text-slate-800 mt-2 hidden"></p>
                    </div>
                </div>

                <div id="actionArea" class="hidden mt-4 flex justify-center">
                    <button type="button" onclick="uploadPDF()"
                        class="bg-blue-600 text-white px-6 py-2 rounded-full text-sm font-bold hover:bg-blue-700 transition shadow-lg flex items-center gap-2 transform active:scale-95">
                        <i class="fa-solid fa-magic"></i> Parse & Auto-Fill Form
                    </button>
                </div>
            </div>

            <div id="uploadStatus" class="mt-3 text-center h-6 transition-all duration-300"></div>
        </div>

        <form action="{{ url_for('add_patient') }}" method="POST" class="p-6 space-y-6" id="patientForm">

            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                    <input type="text" name="name" required
                        class="w-full rounded-lg border-slate-300 border p-2 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Age</label>
                        <input type="number" name="age" min="0" required
                            class="w-full rounded-lg border-slate-300 border p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Gender</label>
                        <select name="gender" class="w-full rounded-lg border-slate-300 border p-2">
                            <option>Male</option>
                            <option>Female</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>
            </div>

            <hr class="border-slate-100">

            <div>
                <h3 class="text-sm font-bold text-slate-900 uppercase mb-4">Vital Signs</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Heart Rate (bpm)</label>
                        <input type="number" name="heart_rate" min="0" required
                            class="w-full rounded-lg border-slate-300 border p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Systolic BP (mmHg)</label>
                        <input type="number" name="systolic_bp" min="0" required
                            class="w-full rounded-lg border-slate-300 border p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Diastolic BP (mmHg)</label>
                        <input type="number" name="diastolic_bp" min="0" required
                            class="w-full rounded-lg border-slate-300 border p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">SpO2 (%)</label>
                        <input type="number" name="spo2" min="0" max="100" required
                            class="w-full rounded-lg border-slate-300 border p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Temp (Â°C)</label>
                        <input type="number" step="0.1" name="temperature" min="0" required
                            class="w-full rounded-lg border-slate-300 border p-2">
                    </div>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Respiratory Rate (/min)</label>
                        <input type="number" name="respiratory_rate" min="0" required
                            class="w-full rounded-lg border-slate-300 border p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">ER Visits (Last 30 Days)</label>
                        <input type="number" name="er_visits" min="0" value="0" required
                            class="w-full rounded-lg border-slate-300 border p-2">
                    </div>
                </div>
            </div>

            <hr class="border-slate-100">

            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">History</label>
                    <input list="history_options" name="history" class="w-full rounded-lg border-slate-300 border p-2"
                        placeholder="Select or type condition...">
                    <datalist id="history_options">
                        <option value="Diabetes">
                        <option value="COPD">
                        <option value="Cardiac Disease">
                        <option value="Hypertension">
                        <option value="Stroke">
                        <option value="Kidney Disease">
                        <option value="Cancer">
                        <option value="Asthma">
                        <option value="Heart Failure">
                        <option value="Pneumonia">
                    </datalist>
                    <p class="text-xs text-slate-500 mt-1">Select from list or type new condition. Hold Ctrl/Cmd to
                        select multiple if using standard select (changed to input for typing).</p>

                    <div class="mt-2 space-y-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="history" value="Diabetes"> <span
                                class="text-sm">Diabetes</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="history" value="COPD"> <span class="text-sm">COPD</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="history" value="Cardiac Disease"> <span class="text-sm">Cardiac
                                Disease</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="history" value="Hypertension"> <span
                                class="text-sm">Hypertension</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="history" value="Asthma"> <span class="text-sm">Asthma</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Lab Indicators</label>
                    <input list="lab_options" name="lab_issues" class="w-full rounded-lg border-slate-300 border p-2"
                        placeholder="Select or type lab issue...">
                    <datalist id="lab_options">
                        <option value="Elevated WBC">
                        <option value="High Creatinine">
                        <option value="High CRP">
                    </datalist>
                    <div class="mt-2 space-y-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="lab_issues" value="Elevated WBC"> <span
                                class="text-sm">Elevated WBC</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="lab_issues" value="High Creatinine"> <span class="text-sm">High
                                Creatinine</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="lab_issues" value="High CRP"> <span class="text-sm">High
                                CRP</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="pt-4 flex justify-end">
                <button type="submit"
                    class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold shadow-lg transform hover:-translate-y-0.5 transition">
                    Calculate Risk & Admit Patient
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function handleFileSelect(input) {
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const actionArea = document.getElementById('actionArea');
        const dropZone = document.getElementById('dropZone');

        if (input.files.length > 0) {
            fileNameDisplay.textContent = input.files[0].name;
            fileNameDisplay.classList.remove('hidden');
            actionArea.classList.remove('hidden');
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        } else {
            fileNameDisplay.classList.add('hidden');
            actionArea.classList.add('hidden');
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        }
    }

    async function uploadPDF() {
        const fileInput = document.getElementById('pdfUpload');
        const status = document.getElementById('uploadStatus');

        if (!fileInput.files.length) {
            status.innerHTML = '<span class="text-red-500 font-bold"><i class="fa-solid fa-circle-xmark"></i> Please select a PDF file first.</span>';
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        status.innerHTML = '<span class="text-blue-600 font-bold animate-pulse"><i class="fa-solid fa-spinner fa-spin"></i> Processing PDF...</span>';

        try {
            const response = await fetch('/upload_pdf', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Upload failed');

            const data = await response.json();

            // Populate Fields logic (same as before)
            if (data.name) document.querySelector('[name="name"]').value = data.name;
            if (data.age) document.querySelector('[name="age"]').value = data.age;
            if (data.gender) document.querySelector('[name="gender"]').value = data.gender;

            if (data.heart_rate) document.querySelector('[name="heart_rate"]').value = data.heart_rate;
            if (data.systolic_bp) document.querySelector('[name="systolic_bp"]').value = data.systolic_bp;
            if (data.diastolic_bp) document.querySelector('[name="diastolic_bp"]').value = data.diastolic_bp;
            if (data.spo2) document.querySelector('[name="spo2"]').value = data.spo2;
            if (data.temperature) document.querySelector('[name="temperature"]').value = data.temperature;
            if (data.respiratory_rate) document.querySelector('[name="respiratory_rate"]').value = data.respiratory_rate;

            // Handle Checkboxes (History & Lab)
            const checkBoxes = (name, items) => {
                const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
                checkboxes.forEach(cb => {
                    if (items && items.some(item => item && cb.value && item.toLowerCase().includes(cb.value.toLowerCase()))) {
                        cb.checked = true;
                    }
                });
            };

            if (data.history) checkBoxes('history', data.history);
            if (data.lab_issues) checkBoxes('lab_issues', data.lab_issues);

            status.innerHTML = '<span class="text-green-600 font-bold"><i class="fa-solid fa-check-circle"></i> Data extracted successfully! Please review fields.</span>';

        } catch (error) {
            console.error(error);
            status.innerHTML = '<span class="text-red-500 font-bold"><i class="fa-solid fa-triangle-exclamation"></i> Error processing PDF. Please check file format.</span>';
        }
    }
</script>
{% endblock %}